# 投资组合回测功能

## 功能概述

投资组合回测功能允许用户基于当前持仓配置，模拟该组合在历史时间段内的表现。

## 主要特性

1. **灵活的时间段选择**
   - 支持自定义日期范围（1个月到10年）
   - 提供快捷选项：1年、3年、5年

2. **关键绩效指标**
   - 总收益和总收益率
   - 年化收益率
   - 最大回撤
   - 波动率（年化标准差）
   - 夏普比率（使用2%无风险利率）

3. **基准对比**
   - 支持多个基准指数：S&P 500、NASDAQ、Dow Jones、上证指数、深证成指
   - 显示超额收益

4. **资产贡献度分析**
   - 展示每个资产对总收益的贡献
   - 按贡献度排序
   - 显示权重和收益率

5. **可视化图表**
   - 累计收益曲线图
   - 资产贡献度条形图
   - 支持深色/浅色主题

## 使用方法

1. 登录系统后，点击左侧导航栏的 "Backtest" 链接
2. 选择回测参数：
   - 选择货币（USD 或 RMB）
   - 选择开始日期和结束日期
   - （可选）选择基准指数
3. 点击"运行回测"按钮
4. 查看回测结果：
   - 绩效指标卡片
   - 累计收益曲线图
   - 资产贡献度分析

## API 端点

### GET /api/backtest

获取投资组合回测结果。

**查询参数：**
- `startDate` (必需): 开始日期，格式 YYYY-MM-DD
- `endDate` (必需): 结束日期，格式 YYYY-MM-DD
- `currency` (可选): 货币类型，USD 或 RMB，默认 USD
- `benchmark` (可选): 基准指数代码，如 ^GSPC

**响应示例：**
```json
{
  "period": {
    "startDate": "2023-01-01T00:00:00Z",
    "endDate": "2024-01-01T00:00:00Z"
  },
  "currency": "USD",
  "performance": [...],
  "metrics": {
    "totalReturn": 15000,
    "totalReturnPercent": 15.0,
    "annualizedReturn": 14.5,
    "maxDrawdown": -8.5,
    "volatility": 12.3,
    "sharpeRatio": 1.18,
    "excessReturn": 3.2
  },
  "assetContributions": [...],
  "benchmark": {
    "symbol": "^GSPC",
    "name": "S&P 500",
    "totalReturn": 11.8
  }
}
```

## 技术实现

### 后端

- **BacktestService**: 核心回测计算服务
  - 权重计算：基于当前持仓市值
  - 历史价值计算：使用当前权重 × 历史价格
  - 绩效指标计算：年化收益率、波动率、夏普比率等
  - 资产贡献度计算：权重 × 收益率

- **缓存优化**: 历史价格数据缓存在 StockAPIService 中

### 前端

- **BacktestPage**: 主页面组件
- **BacktestControls**: 参数控制面板
- **BacktestChart**: 累计收益曲线图（使用 Recharts）
- **BacktestMetrics**: 绩效指标卡片
- **AssetContribution**: 资产贡献度图表

### 性能优化

1. **后端缓存**: 历史价格数据缓存5分钟
2. **前端采样**: 超过200个数据点时自动采样
3. **并行获取**: 使用 goroutines 并行获取多个资产的历史数据

## 注意事项

1. 回测基于当前持仓权重，不考虑历史交易
2. 历史数据可能存在缺失，系统会跳过缺失数据的资产
3. 货币转换使用当前汇率（如果历史汇率不可用）
4. 回测结果仅供参考，不构成投资建议

## 未来改进

- [ ] 支持自定义权重回测
- [ ] 支持多个投资组合对比
- [ ] 添加更多风险指标（VaR、CVaR等）
- [ ] 支持导出回测报告（PDF、CSV）
- [ ] 添加回测结果分享功能
